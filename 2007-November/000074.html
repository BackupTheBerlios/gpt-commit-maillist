<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [gpt-commit] r400 - in trunk/gpt2: common/src gptasm/src	gptasm/test/wikki gptvm/src gptvm/test	gptvm/test/gerados_pelo_gptasm
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/gpt-commit/2007-November/index.html" >
   <LINK REL="made" HREF="mailto:gpt-commit%40lists.berlios.de?Subject=Re%3A%20%5Bgpt-commit%5D%20r400%20-%20in%20trunk/gpt2%3A%20common/src%20gptasm/src%0A%09gptasm/test/wikki%20gptvm/src%20gptvm/test%0A%09gptvm/test/gerados_pelo_gptasm&In-Reply-To=%3C200711291153.lATBr48A007032%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000073.html">
   <LINK REL="Next"  HREF="000075.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[gpt-commit] r400 - in trunk/gpt2: common/src gptasm/src	gptasm/test/wikki gptvm/src gptvm/test	gptvm/test/gerados_pelo_gptasm</H1>
    <B>gpt-commit-noreply at mail.berlios.de</B> 
    <A HREF="mailto:gpt-commit%40lists.berlios.de?Subject=Re%3A%20%5Bgpt-commit%5D%20r400%20-%20in%20trunk/gpt2%3A%20common/src%20gptasm/src%0A%09gptasm/test/wikki%20gptvm/src%20gptvm/test%0A%09gptvm/test/gerados_pelo_gptasm&In-Reply-To=%3C200711291153.lATBr48A007032%40sheep.berlios.de%3E"
       TITLE="[gpt-commit] r400 - in trunk/gpt2: common/src gptasm/src	gptasm/test/wikki gptvm/src gptvm/test	gptvm/test/gerados_pelo_gptasm">gpt-commit-noreply at mail.berlios.de
       </A><BR>
    <I>Thu Nov 29 12:53:04 CET 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000073.html">[gpt-commit] r399 - in trunk/gpt2: gptasm/src gptvm/src
</A></li>
        <LI>Next message: <A HREF="000075.html">[gpt-commit] r401 - in trunk/gpt2: common/src gptasm/src	gptasm/test/wikki gptvm/src gptvm/test/gerados_pelo_gptasm
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#74">[ date ]</a>
              <a href="thread.html#74">[ thread ]</a>
              <a href="subject.html#74">[ subject ]</a>
              <a href="author.html#74">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: alexgarzao
Date: 2007-11-29 12:53:00 +0100 (Thu, 29 Nov 2007)
New Revision: 400

Modified:
   trunk/gpt2/common/src/CSymbol.cpp
   trunk/gpt2/common/src/CSymbolTable.cpp
   trunk/gpt2/common/src/Common.hpp
   trunk/gpt2/gptasm/src/CGenBytecode.cpp
   trunk/gpt2/gptasm/src/CGenBytecode.hpp
   trunk/gpt2/gptasm/src/lexer.g
   trunk/gpt2/gptasm/src/parser.g
   trunk/gpt2/gptasm/test/wikki/enderecamento_1.gasm
   trunk/gpt2/gptasm/test/wikki/estruturas_condicionais_1.gasm
   trunk/gpt2/gptasm/test/wikki/estruturas_repeticao_1.gasm
   trunk/gpt2/gptasm/test/wikki/expressoes_matematicas_1.gasm
   trunk/gpt2/gptasm/test/wikki/funcoes_definidas_usuario_1.gasm
   trunk/gpt2/gptasm/test/wikki/invocando_subrotinas_linguagem_1.gasm
   trunk/gpt2/gptasm/test/wikki/invocando_subrotinas_linguagem_2.gasm
   trunk/gpt2/gptasm/test/wikki/procedimentos_definidos_usuario_1.gasm
   trunk/gpt2/gptasm/test/wikki/procedimentos_definidos_usuario_2.gasm
   trunk/gpt2/gptasm/test/wikki/procedimentos_definidos_usuario_3.gasm
   trunk/gpt2/gptasm/test/wikki/variaveis_1.gasm
   trunk/gpt2/gptasm/test/wikki/variaveis_2.gasm
   trunk/gpt2/gptasm/test/wikki/variaveis_3.gasm
   trunk/gpt2/gptasm/test/wikki/variaveis_4.gasm
   trunk/gpt2/gptasm/test/wikki/variaveis_5.gasm
   trunk/gpt2/gptasm/test/wikki/variaveis_6.gasm
   trunk/gpt2/gptvm/src/CDataStack.cpp
   trunk/gpt2/gptvm/src/CRunBytecode.cpp
   trunk/gpt2/gptvm/src/CRunBytecode.hpp
   trunk/gpt2/gptvm/src/Makefile
   trunk/gpt2/gptvm/test/gerados_pelo_gptasm/estruturas_condicionais_1.gvm
   trunk/gpt2/gptvm/test/gerados_pelo_gptasm/estruturas_repeticao_1.gvm
   trunk/gpt2/gptvm/test/gerados_pelo_gptasm/expressoes_matematicas_1.gvm
   trunk/gpt2/gptvm/test/gerados_pelo_gptasm/funcoes_definidas_usuario_1.gvm
   trunk/gpt2/gptvm/test/gerados_pelo_gptasm/invocando_subrotinas_linguagem_1.gvm
   trunk/gpt2/gptvm/test/gerados_pelo_gptasm/invocando_subrotinas_linguagem_2.gvm
   trunk/gpt2/gptvm/test/gerados_pelo_gptasm/procedimentos_definidos_usuario_1.gvm
   trunk/gpt2/gptvm/test/gerados_pelo_gptasm/procedimentos_definidos_usuario_2.gvm
   trunk/gpt2/gptvm/test/gerados_pelo_gptasm/procedimentos_definidos_usuario_3.gvm
   trunk/gpt2/gptvm/test/gerados_pelo_gptasm/variaveis_1.gvm
   trunk/gpt2/gptvm/test/gerados_pelo_gptasm/variaveis_2.gvm
   trunk/gpt2/gptvm/test/gerados_pelo_gptasm/variaveis_3.gvm
   trunk/gpt2/gptvm/test/gerados_pelo_gptasm/variaveis_4.gvm
   trunk/gpt2/gptvm/test/gerados_pelo_gptasm/variaveis_5.gvm
   trunk/gpt2/gptvm/test/gerados_pelo_gptasm/variaveis_6.gvm
   trunk/gpt2/gptvm/test/run.sh
Log:
DEVNULL:
* Tratamento mais efetivo para enderecamento
  - bit indicando se eh local ou global
  - bit indicando se eh endereco positivo ou negativo
* Mnemonicos/opcodes
  - retirado pop, push, push_int, push_string, push_real, push_char, push_bool,
    push_matrix, push_sreg, pop_sreg, incsp_4, incsp_8, decsp_4, decsp_8
  - incluido pushiv, pushsv, pushrv, pushmv, pushit, pushst, pushrt, pushct,
    pushbt, pushmt, popiv, poprv, popsv, popmv, push0, push1, push2, push3,
    push4, push5, exit0, exit1
* Ajuste nos exemplos em GptAssembly
* Reformulacao na metodologia para passagem de parametros e ajustes de BP e SP


Modified: trunk/gpt2/common/src/CSymbol.cpp
===================================================================
--- trunk/gpt2/common/src/CSymbol.cpp	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/common/src/CSymbol.cpp	2007-11-29 11:53:00 UTC (rev 400)
@@ -2,6 +2,7 @@
 
 
 #include &quot;CSymbol.hpp&quot;
+#include &quot;Tools.hpp&quot;
 
 
 CSymbol::CSymbol()
@@ -42,18 +43,7 @@
 
 int CSymbol::getTypeSize() const
 {
-   switch(_type) {
-   case INT:
-   case CHAR:
-   case BOOL:
-      return sizeof(int);
-   case REAL:
-      return sizeof(double);
-   case STRING:
-   case MATRIX:
-      return sizeof(void*);
-   }
-   return 0;
+   return ::getTypeSize(_type);
 }
 
 

Modified: trunk/gpt2/common/src/CSymbolTable.cpp
===================================================================
--- trunk/gpt2/common/src/CSymbolTable.cpp	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/common/src/CSymbolTable.cpp	2007-11-29 11:53:00 UTC (rev 400)
@@ -1,6 +1,10 @@
 #include &quot;CSymbolTable.hpp&quot;
 
+#include &quot;Common.hpp&quot;
 
+#include &quot;Tools.hpp&quot;
+
+
 CSymbolTable::CSymbolTable()
 {
 }
@@ -34,7 +38,7 @@
 
 CSymbol* CSymbolTable::addParameter (const std::string &amp;name, const int &amp;type, const int &amp;address)
 {
-   CSymbol *symbol = new CSymbol(CSymbol::LOCAL, name, type, CSymbol::PARAM, address | 0x80000000);
+   CSymbol *symbol = new CSymbol(CSymbol::LOCAL, name, type, CSymbol::PARAM, address|SET_LOCAL_BIT|SET_NEG_BIT);
 
    _symbols.push_back(symbol);
 
@@ -68,7 +72,7 @@
    if (scope == CSymbol::GLOBAL) {
       symbol = new CSymbol(scope, name, type, CSymbol::VAR, address);
    } else {
-      symbol = new CSymbol(scope, name, type, CSymbol::VAR, address | 0x80000000 );
+      symbol = new CSymbol(scope, name, type, CSymbol::VAR, address | SET_LOCAL_BIT);
    }
 
    _symbols.push_back(symbol);

Modified: trunk/gpt2/common/src/Common.hpp
===================================================================
--- trunk/gpt2/common/src/Common.hpp	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/common/src/Common.hpp	2007-11-29 11:53:00 UTC (rev 400)
@@ -1,6 +1,29 @@
-#ifndef GPT_COMMON
-#define GPT_COMMON
+#ifndef GPT_COMMON_HPP
+#define GPT_COMMON_HPP
 
+/*
+Mapa de bits para o endereco:
+31: Nao utilizado :-)
+30: Ligado indica endereco local, desligado indica endereco global
+29: Ligado indica endereco negativo, desligado indica endereco positivo
+28..0: valor do endereco
+*/
+
+//const int SET_LOCAL_BIT   = 0x80000000;
+//const int UNSET_LOCAL_BIT = 0x3FFFFFFF;
+
+const int SET_LOCAL_BIT   = 0x40000000; // 01000000 (binario)
+const int UNSET_LOCAL_BIT = 0xBFFFFFFF; // 10111111 (binario)
+
+const int SET_NEG_BIT     = 0x20000000; // 00100000 (binario)
+const int UNSET_NEG_BIT   = 0xDFFFFFFF; // 11011111 (binario)
+
+#define IS_LOCAL_ADDRESS(address) \
+   (address) &amp; SET_LOCAL_BIT
+
+#define IS_NEG_ADDRESS(address) \
+   (address) &amp; SET_NEG_BIT
+
 enum opcode {
    OP_NOP         = 0,
    OP_HLT         = 1,
@@ -77,22 +100,18 @@
    OP_JMP         = 72,
    OP_IF          = 73,
    OP_IFNOT       = 74,
-//   OP_PUSH = 75,
-   OP_POP         = 76,
    OP_INCSP       = 77,
    OP_DECSP       = 78,
-   OP_PUSH_INT    = 79,
-   OP_PUSH_STRING = 80,
-   OP_PUSH_REAL   = 81,
-   OP_PUSH_CHAR   = 82,
-   OP_PUSH_BOOL   = 83,
-   OP_PUSH_MATRIX = 84,
-   OP_PUSH_SREG   = 85,
-   OP_POP_SREG    = 86,
-   OP_INCSP_4     = 87,
-   OP_INCSP_8     = 88,
-   OP_DECSP_4     = 89,
-   OP_DECSP_8     = 90,
+   OP_PUSHIV      = 79,
+   OP_PUSHSV      = 80,
+   OP_PUSHRV      = 81,
+   OP_PUSHMV      = 84,
+   OP_PUSHSREG    = 85,
+   OP_POPSREG     = 86,
+   OP_INCSP4      = 87,
+   OP_INCSP8      = 88,
+   OP_DECSP4      = 89,
+   OP_DECSP8      = 90,
    OP_PCALL       = 91,
    OP_RET         = 92,
    OP_LIBCALL     = 93,
@@ -110,13 +129,25 @@
    OP_MCOPY       = 105,
    OP_MGETSIZE1   = 106,
    OP_MGETSIZE2   = 107,
-   OP_PUSH_ITYPE  = 108,
-   OP_PUSH_STYPE  = 109,
-   OP_PUSH_RTYPE  = 110,
-   OP_PUSH_CTYPE  = 111,
-   OP_PUSH_BTYPE  = 112,
-   OP_PUSH_MTYPE  = 113,
-   OPCODE_NUMBER  = 113
+   OP_PUSHIT      = 108,
+   OP_PUSHST      = 109,
+   OP_PUSHRT      = 110,
+   OP_PUSHCT      = 111,
+   OP_PUSHBT      = 112,
+   OP_PUSHMT      = 113,
+   OP_POPIV       = 114,
+   OP_POPRV       = 115,
+   OP_POPSV       = 116,
+   OP_POPMV       = 117,
+   OP_PUSH0       = 118,
+   OP_PUSH1       = 119,
+   OP_PUSH2       = 120,
+   OP_PUSH3       = 121,
+   OP_PUSH4       = 122,
+   OP_PUSH5       = 123,
+   OP_EXIT0       = 124,
+   OP_EXIT1       = 125,
+   OPCODE_NUMBER  = 125
 };
 
 #endif

Modified: trunk/gpt2/gptasm/src/CGenBytecode.cpp
===================================================================
--- trunk/gpt2/gptasm/src/CGenBytecode.cpp	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/gptasm/src/CGenBytecode.cpp	2007-11-29 11:53:00 UTC (rev 400)
@@ -10,6 +10,7 @@
 
 CGenBytecode::CGenBytecode()
    : _currentSP(0)
+//   , _parametersSize(0)
 {
    _opcodes[ &quot;isum&quot;        ] = OP_ISUM;
    _opcodes[ &quot;ssum&quot;        ] = OP_SSUM;
@@ -84,33 +85,33 @@
    _opcodes[ &quot;if&quot;          ] = OP_IF;
    _opcodes[ &quot;ifnot&quot;       ] = OP_IFNOT;
 //   _opcodes[ &quot;push&quot;        ] = OP_PUSH;
-   _opcodes[ &quot;pop&quot;         ] = OP_POP;
+   _opcodes[ &quot;popiv&quot;         ] = OP_POPIV;
+   _opcodes[ &quot;poprv&quot;         ] = OP_POPRV;
+   _opcodes[ &quot;popmv&quot;         ] = OP_POPMV;
    _opcodes[ &quot;incsp&quot;       ] = OP_INCSP;
    _opcodes[ &quot;decsp&quot;       ] = OP_DECSP;
-//   _opcodes[ &quot;push_0&quot;      ] = OP_PUSH_0;
-//   _opcodes[ &quot;push_1&quot;      ] = OP_PUSH_1;
-//   _opcodes[ &quot;push_2&quot;      ] = OP_PUSH_2;
-//   _opcodes[ &quot;push_3&quot;      ] = OP_PUSH_3;
-//   _opcodes[ &quot;push_4&quot;      ] = OP_PUSH_4;
-//   _opcodes[ &quot;push_5&quot;      ] = OP_PUSH_5;
-   _opcodes[ &quot;push_int&quot;    ] = OP_PUSH_INT;
-   _opcodes[ &quot;push_string&quot; ] = OP_PUSH_STRING;
-   _opcodes[ &quot;push_real&quot;   ] = OP_PUSH_REAL;
-   _opcodes[ &quot;push_char&quot;   ] = OP_PUSH_CHAR;
-   _opcodes[ &quot;push_bool&quot;   ] = OP_PUSH_BOOL;
-   _opcodes[ &quot;push_matrix&quot; ] = OP_PUSH_MATRIX;
-   _opcodes[ &quot;push_itype&quot;  ] = OP_PUSH_ITYPE;
-   _opcodes[ &quot;push_stype&quot;  ] = OP_PUSH_STYPE;
-   _opcodes[ &quot;push_rtype&quot;  ] = OP_PUSH_RTYPE;
-   _opcodes[ &quot;push_ctype&quot;  ] = OP_PUSH_CTYPE;
-   _opcodes[ &quot;push_btype&quot;  ] = OP_PUSH_BTYPE;
-   _opcodes[ &quot;push_mtype&quot;  ] = OP_PUSH_MTYPE;
-   _opcodes[ &quot;push_sreg&quot;   ] = OP_PUSH_SREG;
-   _opcodes[ &quot;pop_sreg&quot;    ] = OP_POP_SREG;
-   _opcodes[ &quot;incsp_4&quot;     ] = OP_INCSP_4;
-   _opcodes[ &quot;incsp_8&quot;     ] = OP_INCSP_8;
-   _opcodes[ &quot;decsp_4&quot;     ] = OP_DECSP_4;
-   _opcodes[ &quot;decsp_8&quot;     ] = OP_DECSP_8;
+   _opcodes[ &quot;push0&quot;       ] = OP_PUSH0;
+   _opcodes[ &quot;push1&quot;       ] = OP_PUSH1;
+   _opcodes[ &quot;push2&quot;       ] = OP_PUSH2;
+   _opcodes[ &quot;push3&quot;       ] = OP_PUSH3;
+   _opcodes[ &quot;push4&quot;       ] = OP_PUSH4;
+   _opcodes[ &quot;push5&quot;       ] = OP_PUSH5;
+   _opcodes[ &quot;pushiv&quot;      ] = OP_PUSHIV;
+   _opcodes[ &quot;pushsv&quot;      ] = OP_PUSHSV;
+   _opcodes[ &quot;pushrv&quot;      ] = OP_PUSHRV;
+   _opcodes[ &quot;pushmv&quot;      ] = OP_PUSHMV;
+   _opcodes[ &quot;pushit&quot;      ] = OP_PUSHIT;
+   _opcodes[ &quot;pushst&quot;      ] = OP_PUSHST;
+   _opcodes[ &quot;pushrt&quot;      ] = OP_PUSHRT;
+   _opcodes[ &quot;pushct&quot;      ] = OP_PUSHCT;
+   _opcodes[ &quot;pushbt&quot;      ] = OP_PUSHBT;
+   _opcodes[ &quot;pushmt&quot;      ] = OP_PUSHMT;
+   _opcodes[ &quot;pushsreg&quot;    ] = OP_PUSHSREG;
+   _opcodes[ &quot;popsreg&quot;     ] = OP_POPSREG;
+   _opcodes[ &quot;incsp4&quot;      ] = OP_INCSP4;
+   _opcodes[ &quot;incsp8&quot;      ] = OP_INCSP8;
+   _opcodes[ &quot;decsp4&quot;      ] = OP_DECSP4;
+   _opcodes[ &quot;decsp8&quot;      ] = OP_DECSP8;
    _opcodes[ &quot;pcall&quot;       ] = OP_PCALL;
    _opcodes[ &quot;ret&quot;         ] = OP_RET;
    _opcodes[ &quot;libcall&quot;     ] = OP_LIBCALL;
@@ -129,8 +130,8 @@
    _opcodes[ &quot;mgetsize1&quot;   ] = OP_MGETSIZE1;
    _opcodes[ &quot;mgetsize2&quot;   ] = OP_MGETSIZE2;
    _opcodes[ &quot;nop&quot;         ] = OP_NOP;
-//   _opcodes[ &quot;exit_0&quot;      ] = OP_EXIT_0;
-//   _opcodes[ &quot;exit_1&quot;      ] = OP_EXIT_1;
+   _opcodes[ &quot;exit0&quot;       ] = OP_EXIT0;
+   _opcodes[ &quot;exit1&quot;       ] = OP_EXIT1;
    _opcodes[ &quot;hlt&quot;         ] = OP_HLT;
    _opcodes[ &quot;exit&quot;        ] = OP_EXIT;
 }
@@ -149,6 +150,8 @@
    _currentProcedure = procedureName;
    _currentSP = 0;
     registryLabel(procedureName);
+   _parameters.clear();
+//   _parametersSize = 0;
 }
 
 
@@ -156,6 +159,7 @@
 {
    _currentProcedure.clear();
    _currentSP = 0;
+//   _parametersSize = 0;
    _symbolTable.clearLocalSymbols();
    // TODO: delete na procedure ???
 }
@@ -182,12 +186,43 @@
 
 void CGenBytecode::makeParDefinition(const std::string &amp;lexeme, const int &amp;type)
 {
-   CSymbol *symbol = _symbolTable.addParameter(lexeme, type, _currentSP);
-   std::cout &lt;&lt; &quot;par &quot; &lt;&lt; lexeme &lt;&lt; &quot; address &quot; &lt;&lt; _currentSP &lt;&lt; std::endl;
-   _currentSP += symbol-&gt;getTypeSize();
+   _parameters.push_back(std::pair&lt;std::string,int&gt;(lexeme, type));
+//   _parametersSize += getTypeSize(type);
+//   CSymbol *symbol = _symbolTable.addParameter(lexeme, type, _currentSP);
+//   std::cout &lt;&lt; &quot;par &quot; &lt;&lt; lexeme &lt;&lt; &quot; address &quot; &lt;&lt; _currentSP &lt;&lt; std::endl;
+//   _currentSP += symbol-&gt;getTypeSize();
 }
 
 
+void CGenBytecode::finishParDefinition()
+{
+   _currentSP = 0;
+   for (std::list&lt;std::pair&lt;std::string,int&gt; &gt;::reverse_iterator par = _parameters.rbegin();
+         par != _parameters.rend(); par++) {
+      _currentSP -= getTypeSize(par-&gt;second);
+      CSymbol *symbol = _symbolTable.addParameter(par-&gt;first, par-&gt;second, abs(_currentSP));
+//      std::cout &lt;&lt; &quot;par &quot; &lt;&lt; par-&gt;first &lt;&lt; &quot; address &quot; &lt;&lt; _currentSP &lt;&lt; std::endl;
+      std::cout &lt;&lt; &quot;param=&quot; &lt;&lt; symbol-&gt;getName() &lt;&lt; &quot; address=&quot; &lt;&lt; symbol-&gt;getAddress() &lt;&lt; std::endl;
+      std::cout &lt;&lt; &quot;\t&quot; &lt;&lt; realAddressString(symbol-&gt;getAddress()) &lt;&lt; std::endl;
+   }
+
+   _currentSP = 0;
+
+//   if (_parametersSize != 0) {
+//      std::cout &lt;&lt; &quot;_parametersSize != 0 !!!&quot; &lt;&lt; std::endl;
+//      abort();
+//   }
+}
+
+
+//void CGenBytecode::makeParDefinition(const std::string &amp;lexeme, const int &amp;type)
+//{
+//   CSymbol *symbol = _symbolTable.addParameter(lexeme, type, _currentSP);
+//   std::cout &lt;&lt; &quot;par &quot; &lt;&lt; lexeme &lt;&lt; &quot; address &quot; &lt;&lt; _currentSP &lt;&lt; std::endl;
+//   _currentSP += symbol-&gt;getTypeSize();
+//}
+
+
 void CGenBytecode::registryLabel(const std::string &amp;labelName)
 {
    // TODO

Modified: trunk/gpt2/gptasm/src/CGenBytecode.hpp
===================================================================
--- trunk/gpt2/gptasm/src/CGenBytecode.hpp	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/gptasm/src/CGenBytecode.hpp	2007-11-29 11:53:00 UTC (rev 400)
@@ -19,6 +19,7 @@
    void finishProcedure();
    void makeVarDefinition(const std::string &amp;lexeme, const int &amp;type);
    void makeParDefinition(const std::string &amp;lexeme, const int &amp;type);
+   void finishParDefinition();
    void registryLabel(const std::string &amp;labelName);
    void addOpcode(const std::string &amp;mn);
    void addAddress(const std::string &amp;id, const int &amp;category, const int &amp;type);
@@ -34,8 +35,10 @@
    std::map&lt;std::string,char&gt; _opcodes;
    std::string                _currentProcedure;
    int                        _currentSP;
+//   int                        _parametersSize;
    std::list&lt;std::pair&lt;std::string, int&gt; &gt; _unsolvedLabels;
    std::map&lt;std::string, int&gt; _solvedLabels;
+   std::list&lt;std::pair&lt;std::string, int&gt; &gt; _parameters;
 };
 
 #endif

Modified: trunk/gpt2/gptasm/src/lexer.g
===================================================================
--- trunk/gpt2/gptasm/src/lexer.g	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/gptasm/src/lexer.g	2007-11-29 11:53:00 UTC (rev 400)
@@ -111,33 +111,34 @@
    T_KW_JMP=&quot;jmp&quot;;
    T_KW_IF=&quot;if&quot;;
    T_KW_IFNOT=&quot;ifnot&quot;;
-   T_KW_POP=&quot;pop&quot;;
+   T_KW_POPIV=&quot;popiv&quot;;
+   T_KW_POPSV=&quot;popsv&quot;;
+   T_KW_POPRV=&quot;poprv&quot;;
+   T_KW_POPMV=&quot;popmv&quot;;
    T_KW_INCSP=&quot;incsp&quot;;
    T_KW_DECSP=&quot;decsp&quot;;
-//   T_KW_PUSH_0=&quot;push_0&quot;;
-//   T_KW_PUSH_1=&quot;push_1&quot;;
-//   T_KW_PUSH_2=&quot;push_2&quot;;
-//   T_KW_PUSH_3=&quot;push_3&quot;;
-//   T_KW_PUSH_4=&quot;push_4&quot;;
-//   T_KW_PUSH_5=&quot;push_5&quot;;
-   T_KW_PUSH_INT=&quot;push_int&quot;;
-   T_KW_PUSH_STRING=&quot;push_string&quot;;
-   T_KW_PUSH_REAL=&quot;push_real&quot;;
-   T_KW_PUSH_CHAR=&quot;push_char&quot;;
-   T_KW_PUSH_BOOL=&quot;push_bool&quot;;
-   T_KW_PUSH_MATRIX=&quot;push_matrix&quot;;
-   T_KW_PUSH_ITYPE=&quot;push_itype&quot;;
-   T_KW_PUSH_STYPE=&quot;push_stype&quot;;
-   T_KW_PUSH_RTYPE=&quot;push_rtype&quot;;
-   T_KW_PUSH_CTYPE=&quot;push_ctype&quot;;
-   T_KW_PUSH_BTYPE=&quot;push_btype&quot;;
-   T_KW_PUSH_MTYPE=&quot;push_mtype&quot;;
-   T_KW_PUSH_SP=&quot;push_sreg&quot;;
-   T_KW_POP_SP=&quot;pop_sreg&quot;;
-   T_KW_INCSP_4=&quot;incsp_4&quot;;
-   T_KW_INCSP_8=&quot;incsp_8&quot;;
-   T_KW_DECSP_4=&quot;decsp_4&quot;;
-   T_KW_DECSP_8=&quot;decsp_8&quot;;
+   T_KW_PUSH0=&quot;push0&quot;;
+   T_KW_PUSH1=&quot;push1&quot;;
+   T_KW_PUSH2=&quot;push2&quot;;
+   T_KW_PUSH3=&quot;push3&quot;;
+   T_KW_PUSH4=&quot;push4&quot;;
+   T_KW_PUSH5=&quot;push5&quot;;
+   T_KW_PUSHIV=&quot;pushiv&quot;;
+   T_KW_PUSHSV=&quot;pushsv&quot;;
+   T_KW_PUSHRV=&quot;pushrv&quot;;
+   T_KW_PUSHMV=&quot;pushmv&quot;;
+   T_KW_PUSHIT=&quot;pushit&quot;;
+   T_KW_PUSHST=&quot;pushst&quot;;
+   T_KW_PUSHRT=&quot;pushrt&quot;;
+   T_KW_PUSHCT=&quot;pushct&quot;;
+   T_KW_PUSHBT=&quot;pushbt&quot;;
+   T_KW_PUSHMT=&quot;pushmt&quot;;
+//   T_KW_PUSHSREG=&quot;pushsreg&quot;;
+//   T_KW_POPSREG=&quot;popsreg&quot;;
+   T_KW_INCSP4=&quot;incsp4&quot;;
+   T_KW_INCSP8=&quot;incsp8&quot;;
+   T_KW_DECSP4=&quot;decsp4&quot;;
+   T_KW_DECSP8=&quot;decsp8&quot;;
    T_KW_PCALL=&quot;pcall&quot;;
    T_KW_LIBCALL=&quot;libcall&quot;;
    T_KW_RET=&quot;ret&quot;;
@@ -156,8 +157,8 @@
    T_KW_MGETSIZE1=&quot;mgetsize1&quot;;
    T_KW_MGETSIZE2=&quot;mgetsize2&quot;;
    T_KW_NOP=&quot;nop&quot;;
-//   T_KW_EXIT_0=&quot;exit_0&quot;;
-//   T_KW_EXIT_1=&quot;exit_1&quot;;
+   T_KW_EXIT0=&quot;exit0&quot;;
+   T_KW_EXIT1=&quot;exit1&quot;;
    T_KW_HLT=&quot;hlt&quot;;
    T_KW_EXIT=&quot;exit&quot;;
    T_KW_TRUE=&quot;true&quot;;

Modified: trunk/gpt2/gptasm/src/parser.g
===================================================================
--- trunk/gpt2/gptasm/src/parser.g	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/gptasm/src/parser.g	2007-11-29 11:53:00 UTC (rev 400)
@@ -27,14 +27,6 @@
 {  
    public:
       CGenBytecode bytecode;
-      void declareVar(const std::string&amp; lexeme, int type)
-      {
-         bytecode.makeVarDefinition( lexeme, type );
-      }
-      void declareParameter(const std::string&amp; lexeme, int type)
-      {
-         bytecode.makeParDefinition( lexeme, type );
-      }
       antlr::RefToken getLastToken()
       {
          return LT(0);
@@ -86,7 +78,7 @@
   char tk_type;
 }
   : &quot;var&quot; tk_id:T_ID tk_type=primitive_type
-    { declareVar(tk_id-&gt;getText(), tk_type); }
+    { bytecode.makeVarDefinition(tk_id-&gt;getText(), tk_type); }
   ;
 
 //--------------------------------
@@ -112,6 +104,7 @@
    tk_id:T_ID
     { bytecode.initProcedure(tk_id-&gt;getText(), false, 0, std::vector&lt;CSymbol&gt;()); }
     (parameter_declaration)*
+    { bytecode.finishParDefinition(); }
     (var_declaration)*
     code_block
     { bytecode.finishProcedure(); }
@@ -125,7 +118,7 @@
   int tk_type;
 }
   : &quot;param&quot; (&quot;ref&quot;)? tk_id:T_ID tk_type=primitive_type
-    { declareParameter( tk_id-&gt;getText(), tk_type ); }
+    { bytecode.makeParDefinition(tk_id-&gt;getText(), tk_type); }
   ;
 
 //#####################
@@ -245,24 +238,25 @@
 //--------------------
   mn_chamada_subrotina
 //--------------------
-   :  (&quot;push_int&quot;|&quot;push_string&quot;|&quot;push_real&quot;|&quot;push_char&quot;|&quot;push_bool&quot;|&quot;push_matrix&quot;)
+   :  (&quot;pushiv&quot;|&quot;pushsv&quot;|&quot;pushrv&quot;|&quot;pushmv&quot;)
       {bytecode.addOpcode(getLastTokenText());}
       element
-   |  (&quot;push_itype&quot;|&quot;push_stype&quot;|&quot;push_rtype&quot;|&quot;push_ctype&quot;|&quot;push_btype&quot;|&quot;push_mtype&quot;)
+   |  (&quot;pushit&quot;|&quot;pushst&quot;|&quot;pushrt&quot;|&quot;pushct&quot;|&quot;pushbt&quot;|&quot;pushmt&quot;)
       {bytecode.addOpcode(getLastTokenText());}
-   |  &quot;pop&quot;
+//   |  &quot;pop&quot;
+   |  (&quot;popiv&quot;|&quot;popsv&quot;|&quot;poprv&quot;|&quot;popmv&quot;)
       {bytecode.addOpcode(getLastTokenText());}
       identifier
    |  (&quot;incsp&quot;|&quot;decsp&quot;)
       {bytecode.addOpcode(getLastTokenText());}
       T_INT_VALUE
       { bytecode.addAddress(getLastTokenText(), CSymbol::CONST, CSymbol::INT); }
-//   |  (&quot;push_0&quot;|&quot;push_1&quot;|&quot;push_2&quot;|&quot;push_3&quot;|&quot;push_4&quot;|&quot;push_5&quot;)
+   |  (&quot;push0&quot;|&quot;push1&quot;|&quot;push2&quot;|&quot;push3&quot;|&quot;push4&quot;|&quot;push5&quot;)
+      {bytecode.addOpcode(getLastTokenText());}
+//   |  (&quot;pushsreg&quot;|&quot;popsreg&quot;)
 //      {bytecode.addOpcode(getLastTokenText());}
-   |  (&quot;push_sreg&quot;|&quot;pop_sreg&quot;)
+   |  (&quot;incsp4&quot;|&quot;incsp8&quot;|&quot;decsp4&quot;|&quot;decsp8&quot;)
       {bytecode.addOpcode(getLastTokenText());}
-   |  (&quot;incsp_4&quot;|&quot;incsp_8&quot;|&quot;decsp_4&quot;|&quot;decsp_8&quot;)
-      {bytecode.addOpcode(getLastTokenText());}
    |  &quot;pcall&quot;
       {bytecode.addOpcode(getLastTokenText());}
       T_ID
@@ -337,8 +331,7 @@
 //-----------
   mn_execucao
 //-----------
-//   :   (&quot;nop&quot;|&quot;exit_0&quot;|&quot;exit_1&quot;|&quot;hlt&quot;)
-   :   (&quot;nop&quot;|&quot;hlt&quot;)
+   :   (&quot;nop&quot;|&quot;hlt&quot;|&quot;exit0&quot;|&quot;exit1&quot;)
       {bytecode.addOpcode(getLastTokenText());}
    |   &quot;exit&quot;
       {bytecode.addOpcode(getLastTokenText());}

Modified: trunk/gpt2/gptasm/test/wikki/enderecamento_1.gasm
===================================================================
--- trunk/gpt2/gptasm/test/wikki/enderecamento_1.gasm	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/gptasm/test/wikki/enderecamento_1.gasm	2007-11-29 11:53:00 UTC (rev 400)
@@ -12,28 +12,24 @@
     isetv c:4, 20 // *(c + 4 ) := 20
 
     // imprima( &quot;c.x=&quot;, c.x );
-    push_sp
     igetv t1, c:0 // t1 := *( c + 0)
-    push t1
-    push_int
-    push &quot;c.x=&quot;
-    push_string
-    push_2
-    pcall imprima
-    pop_sp
+    pushiv t1
+    pushit
+    pushsv &quot;c.x=&quot;
+    pushst
+    pushiv 2
+    libcall imprima
 
     // imprima( &quot;c.y=&quot;, c.y );
-    push_sp
     igetv t1, c:4 // t1 := *(c + 4)
-    push t1
-    push_int
-    push &quot;c.y=&quot;
-    push_string
-    push_2
-    pcall imprima
-    pop_sp
+    pushiv t1
+    pushit
+    pushsv &quot;c.y=&quot;
+    pushst
+    pushiv 2
+    libcall imprima
 
-    exit_0
+    exit 0
 endproc
 
 endprogram

Modified: trunk/gpt2/gptasm/test/wikki/estruturas_condicionais_1.gasm
===================================================================
--- trunk/gpt2/gptasm/test/wikki/estruturas_condicionais_1.gasm	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/gptasm/test/wikki/estruturas_condicionais_1.gasm	2007-11-29 11:53:00 UTC (rev 400)
@@ -24,14 +24,12 @@
     proximo:
 
     // imprima( x );
-    push_sreg
-    push_int x
-    push_itype
-    push_int 1
+    pushiv x
+    pushit
+    push1
     libcall imprima
-    pop_sreg
 
-    exit 0
+    exit0
 endproc
 
 endprogram

Modified: trunk/gpt2/gptasm/test/wikki/estruturas_repeticao_1.gasm
===================================================================
--- trunk/gpt2/gptasm/test/wikki/estruturas_repeticao_1.gasm	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/gptasm/test/wikki/estruturas_repeticao_1.gasm	2007-11-29 11:53:00 UTC (rev 400)
@@ -1,10 +1,9 @@
 program exemplo
 
 var x int
-var t1 int
 
 proc main
-//    var t1 int
+    var t1 int
 
     // para x de 1 at&#233; 10 fa&#231;a
     iset x, 1
@@ -13,12 +12,10 @@
     ifnot t1, proximo
 
     // imprima( x );
-    push_sreg
-    push_int x
-    push_itype
-    push_int 1
+    pushiv x
+    pushit
+    push1
     libcall imprima
-    pop_sreg
 
     // fim-para
     iinc x, 1
@@ -26,7 +23,7 @@
 
     proximo:
 
-    exit 0
+    exit0
 endproc
 
 endprogram

Modified: trunk/gpt2/gptasm/test/wikki/expressoes_matematicas_1.gasm
===================================================================
--- trunk/gpt2/gptasm/test/wikki/expressoes_matematicas_1.gasm	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/gptasm/test/wikki/expressoes_matematicas_1.gasm	2007-11-29 11:53:00 UTC (rev 400)
@@ -5,16 +5,14 @@
     var t2 int
 
     // imprima( &quot;2+5*3=&quot;, 2+5*3 );
-    push_sreg
     imul t1, 5, 3
     isum t2, 2, t1
-    push_int t2
-    push_itype
-    push_string &quot;2+5*3=&quot;
-    push_stype
-    push_int 2
+    pushiv t2
+    pushit
+    pushsv &quot;2+5*3=&quot;
+    pushst
+    pushiv 2
     libcall imprima
-    pop_sreg
 
     exit 0
 endproc

Modified: trunk/gpt2/gptasm/test/wikki/funcoes_definidas_usuario_1.gasm
===================================================================
--- trunk/gpt2/gptasm/test/wikki/funcoes_definidas_usuario_1.gasm	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/gptasm/test/wikki/funcoes_definidas_usuario_1.gasm	2007-11-29 11:53:00 UTC (rev 400)
@@ -1,20 +1,21 @@
 program exemplo
 
 proc main
+    var t1 int
     // imprima( &quot;A soma &#233;: &quot;, soma( 2, 7 ) );
-    push_sp
-    push_0 // resultado da fun&#231;&#227;o
-    push 7 // empilha 7
-    push 2 // empilha 2
+    pushiv 0 // resultado da fun&#231;&#227;o
+    pushiv 2 // empilha 2
+    pushiv 7 // empilha 7
     pcall soma
-    push_int
-    push &quot;A soma &#233;: &quot;
-    push_string
-    push_2
-    pcall imprima
-    pop_sp
-	
-    exit_0
+    popiv t1
+    pushiv t1
+    pushit
+    pushsv &quot;A soma &#233;: &quot;
+    pushst
+    pushiv 2
+    libcall imprima
+
+    exit 0
 endproc
 
 proc soma
@@ -24,6 +25,7 @@
 
     isum __result, x, y
 
+    decsp 8 // tamanho dos parametros + variaveis locais - retorno da funcao
     ret
 endproc
 

Modified: trunk/gpt2/gptasm/test/wikki/invocando_subrotinas_linguagem_1.gasm
===================================================================
--- trunk/gpt2/gptasm/test/wikki/invocando_subrotinas_linguagem_1.gasm	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/gptasm/test/wikki/invocando_subrotinas_linguagem_1.gasm	2007-11-29 11:53:00 UTC (rev 400)
@@ -1,12 +1,10 @@
 program exemplo
 
 proc main
-    push_sreg
-    push_string &quot;Ol&#225; mundo !!!&quot;
-    push_stype
-    push_int 1
+    pushsv &quot;Ol&#225; mundo !!!&quot;
+    pushst
+    pushiv 1
     libcall imprima
-    pop_sreg
 
     exit 0
 endproc

Modified: trunk/gpt2/gptasm/test/wikki/invocando_subrotinas_linguagem_2.gasm
===================================================================
--- trunk/gpt2/gptasm/test/wikki/invocando_subrotinas_linguagem_2.gasm	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/gptasm/test/wikki/invocando_subrotinas_linguagem_2.gasm	2007-11-29 11:53:00 UTC (rev 400)
@@ -4,29 +4,23 @@
 
 proc main
     // imprima( &quot;Digite um n&#250;mero: &quot; );
-    push_sp
-    push &quot;Digite um n&#250;mero: &quot;
-    push_string
-    push_1
-    pcall imprima
-    pop_sp
+    pushsv &quot;Digite um n&#250;mero: &quot;
+    pushst
+    pushiv 1
+    libcall imprima
     // x := leia( );
-    push_0 // resultado da fun&#231;&#227;o
-    push_sp
-    pcall leia
-    pop_sp
-    pop x
+    pushit
+    libcall leia
+    popiv x
     // imprima( &quot;O n&#250;mero digitado foi &quot;, x );
-    push_sp
-    push x
-    push_int
-    push &quot;O n&#250;mero digitado foi &quot;
-    push_string
-    push_2
-    pcall imprima
-    pop_sp
+    pushiv x
+    pushit
+    pushsv &quot;O n&#250;mero digitado foi &quot;
+    pushst
+    pushiv 2
+    libcall imprima
 
-    exit_0
+    exit 0
 endproc
 
 endprogram

Modified: trunk/gpt2/gptasm/test/wikki/procedimentos_definidos_usuario_1.gasm
===================================================================
--- trunk/gpt2/gptasm/test/wikki/procedimentos_definidos_usuario_1.gasm	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/gptasm/test/wikki/procedimentos_definidos_usuario_1.gasm	2007-11-29 11:53:00 UTC (rev 400)
@@ -2,12 +2,14 @@
 
 proc main
     // soma( 2, 7 );
-    push_sreg
-    push_int 2
-    push_int 7
+    pushiv 2
+    pushiv 7
     pcall soma
-    pop_sreg
 
+    pushiv 10
+    pushiv 20
+    pcall soma
+
     exit 0
 endproc
 
@@ -17,21 +19,18 @@
 
     var t1 int
 
-//    push_sreg
-//    push_string &quot;A soma &#233;: &quot;
-//    push_stype
-//    push_int 1
-//    libcall imprima
-//    pop_sreg
+    pushsv &quot;A soma &#233;: &quot;
+    pushst
+    pushiv 1
+    libcall imprima
 
     isum t1, x, y
-//    push_sreg
-    push_int t1
-    push_itype
-    push_int 1
+    pushiv t1
+    pushit
+    pushiv 1
     libcall imprima
-//    pop_sreg
 
+    decsp 12
     ret	
 endproc
 

Modified: trunk/gpt2/gptasm/test/wikki/procedimentos_definidos_usuario_2.gasm
===================================================================
--- trunk/gpt2/gptasm/test/wikki/procedimentos_definidos_usuario_2.gasm	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/gptasm/test/wikki/procedimentos_definidos_usuario_2.gasm	2007-11-29 11:53:00 UTC (rev 400)
@@ -4,33 +4,31 @@
 
 proc main
     // soma( s, 2, 7 );
-    push_sp
-    push 7
-    push 2
-    push s
+    pushiv s
+    pushiv 2
+    pushiv 7
     pcall soma
-    pop_sp
 	
     // imprima( s );
-    push_sp
-    push s
-    push_int
-    push_1
-    pcall imprima
-    pop_sp
+    pushiv s
+    pushit
+    pushiv 1
+    libcall imprima
 	
-    exit_0
+    exit 0
 endproc
 
 proc soma
     param r int
     param v1 int
     param v2 int
+    var t1 int
 
     // r := v1 + v2;
     isum t1, v1, v2
     isetv r:0, t1
 
+    decsp 16
     ret	
 endproc
 

Modified: trunk/gpt2/gptasm/test/wikki/procedimentos_definidos_usuario_3.gasm
===================================================================
--- trunk/gpt2/gptasm/test/wikki/procedimentos_definidos_usuario_3.gasm	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/gptasm/test/wikki/procedimentos_definidos_usuario_3.gasm	2007-11-29 11:53:00 UTC (rev 400)
@@ -1,16 +1,12 @@
 program exemplo
 
 proc main
-   push_sreg
    pcall soma
-   pop_sreg
 
-   push_sreg
-   push_string &quot;Finalizando...&quot;
-   push_stype
-   push_int 1
+   pushsv &quot;Finalizando...&quot;
+   pushst
+   pushiv 1
    libcall imprima
-   pop_sreg
 
    exit 0
 endproc
@@ -20,13 +16,12 @@
 
    isum temp, 2, 4
 
-   push_sreg
-   push_int temp
-   push_itype
-   push_int 1
+   pushiv temp
+   pushit
+   pushiv 1
    libcall imprima
-   pop_sreg
 
+   decsp 4
    ret
 endproc
    

Modified: trunk/gpt2/gptasm/test/wikki/variaveis_1.gasm
===================================================================
--- trunk/gpt2/gptasm/test/wikki/variaveis_1.gasm	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/gptasm/test/wikki/variaveis_1.gasm	2007-11-29 11:53:00 UTC (rev 400)
@@ -3,9 +3,6 @@
 var x int
 var y int
 
-//    var t1 int
-//    var t2 int
-
 proc main
     var t1 int
     var t2 int
@@ -17,16 +14,14 @@
     iset y, 20
 	
     // imprima( &quot;x*y+4=&quot;, x*y+4 );
-    push_sreg
     imul t1, x, y
     isum t2, t1, 4
-    push_int t2
-    push_itype
-    push_string &quot;x*y+4=&quot;
-    push_stype
-    push_int 2
+    pushiv t2
+    pushit
+    pushsv &quot;x*y+4=&quot;
+    pushst
+    pushiv 2
     libcall imprima
-    pop_sreg
 	
     exit 0
 endproc

Modified: trunk/gpt2/gptasm/test/wikki/variaveis_2.gasm
===================================================================
--- trunk/gpt2/gptasm/test/wikki/variaveis_2.gasm	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/gptasm/test/wikki/variaveis_2.gasm	2007-11-29 11:53:00 UTC (rev 400)
@@ -10,21 +10,17 @@
     isum v, v, 10
     isum v, 10, v
 
-    push_sp
-    push v
-    push_int
-    push_1
-    pcall imprima
-    pop_sp
+    pushiv v
+    pushit
+    pushiv 1
+    libcall imprima
 	
-    push_sp
-    push 10
-    push_int
-    push_1
-    pcall imprima
-    pop_sp
+    pushiv 10
+    pushit
+    pushiv 1
+    libcall imprima
 	
-    exit_0
+    exit 0
 endproc
 
 endprogram

Modified: trunk/gpt2/gptasm/test/wikki/variaveis_3.gasm
===================================================================
--- trunk/gpt2/gptasm/test/wikki/variaveis_3.gasm	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/gptasm/test/wikki/variaveis_3.gasm	2007-11-29 11:53:00 UTC (rev 400)
@@ -10,21 +10,17 @@
     rsum v, v, 10.0
     rsum v, 10.0, v
 
-    push_sp
-    push v
-    push_real
-    push_1
-    pcall imprima
-    pop_sp
+    pushrv v
+    pushrt
+    pushrv 1
+    libcall imprima
 
-    push_sp
-    push 10.0
-    push_real
-    push_1
-    pcall imprima
-    pop_sp
+    pushrv 10.0
+    pushrt
+    pushrv 1
+    libcall imprima
 
-    exit_0
+    exit 0
 endproc
 
 endprogram

Modified: trunk/gpt2/gptasm/test/wikki/variaveis_4.gasm
===================================================================
--- trunk/gpt2/gptasm/test/wikki/variaveis_4.gasm	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/gptasm/test/wikki/variaveis_4.gasm	2007-11-29 11:53:00 UTC (rev 400)
@@ -12,23 +12,19 @@
     ssum v, v, &quot;10&quot;
     ssum v, &quot;10&quot;, v
 
-    push_sp
-    push v
-    push_string
-    push_1
-    pcall imprima
-    pop_sp
+    pushsv v
+    pushst
+    pushiv 1
+    libcall imprima
 	
-    push_sp
-    push &quot;10&quot;
-    push_string
-    push_1
-    pcall imprima
-    pop_sp
+    pushsv &quot;10&quot;
+    pushst
+    pushiv 1
+    libcall imprima
 	
     sfree v
 
-    exit_0
+    exit 0
 endproc
 
 endprogram

Modified: trunk/gpt2/gptasm/test/wikki/variaveis_5.gasm
===================================================================
--- trunk/gpt2/gptasm/test/wikki/variaveis_5.gasm	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/gptasm/test/wikki/variaveis_5.gasm	2007-11-29 11:53:00 UTC (rev 400)
@@ -10,21 +10,17 @@
     isum v, v, 'a'
     isum v, 'b', v
 
-    push_sp
-    push v
-    push_char
-    push_1
-    pcall imprima
-    pop_sp
+    pushiv v
+    pushct
+    pushiv 1
+    libcall imprima
 
-    push_sp
-    push 'a'
-    push_char
-    push_1
-    pcall imprima
-    pop_sp
+    pushiv 'a'
+    pushct
+    pushiv 1
+    libcall imprima
 
-    exit_0
+    exit 0
 endproc
 
 endprogram

Modified: trunk/gpt2/gptasm/test/wikki/variaveis_6.gasm
===================================================================
--- trunk/gpt2/gptasm/test/wikki/variaveis_6.gasm	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/gptasm/test/wikki/variaveis_6.gasm	2007-11-29 11:53:00 UTC (rev 400)
@@ -7,28 +7,22 @@
     iset v, false
     iset v, v
 
-    push_sp
-    push true
-    push_bool
-    push_1
-    pcall imprima
-    pop_sp
+    pushiv true
+    pushbt
+    pushiv 1
+    libcall imprima
 
-    push_sp
-    push false
-    push_bool
-    push_1
-    pcall imprima
-    pop_sp
+    pushiv false
+    pushbt
+    pushiv 1
+    libcall imprima
 
-    push_sp
-    push v
-    push_bool
-    push_1
-    pcall imprima
-    pop_sp
+    pushiv v
+    pushbt
+    pushiv 1
+    libcall imprima
 
-    exit_0
+    exit 0
 endproc
 
 endprogram

Modified: trunk/gpt2/gptvm/src/CDataStack.cpp
===================================================================
--- trunk/gpt2/gptvm/src/CDataStack.cpp	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/gptvm/src/CDataStack.cpp	2007-11-29 11:53:00 UTC (rev 400)
@@ -1,6 +1,11 @@
 #include &quot;CDataStack.hpp&quot;
 
+#include &quot;Common.hpp&quot;
 
+#include &quot;Tools.hpp&quot;
+
+
+
 #include &lt;iostream&gt;
 
 
@@ -15,13 +20,12 @@
 {
 }
 
-
 void CDataStack::setInt(const int &amp;address, const int &amp;value)
 {
 //   std::cout &lt;&lt; &quot;setInt &quot;;
-   if (address &amp; 0x80000000) {
-//      std::cout &lt;&lt; &quot;local address sem bit ligado: &quot; &lt;&lt; (address &amp; 0x7FFFFFFF) &lt;&lt; std::endl;
-      CBinString::setInt(_BS + (address &amp; 0x7FFFFFFF), value);
+   if (IS_LOCAL_ADDRESS(address)) {
+//      std::cout &lt;&lt; &quot;local address sem bit ligado: &quot; &lt;&lt; ((unsigned int)address &amp; UNSET_BIT_LOCAL) &lt;&lt; std::endl;
+      CBinString::setInt(_BS + realAddress(address), value);
    } else {
       std::cout &lt;&lt; &quot;ERRO !!! Invocando setInt com global address: &quot; &lt;&lt; address &lt;&lt; std::endl;
    }
@@ -31,9 +35,9 @@
 int CDataStack::getInt(const int &amp;address)
 {
 //   std::cout &lt;&lt; &quot;getInt &quot;;
-   if (address &amp; 0x80000000) {
-//      std::cout &lt;&lt; &quot;local address sem bit ligado: &quot; &lt;&lt; (address &amp; 0x7FFFFFFF) &lt;&lt; std::endl;
-      return CBinString::getInt(_BS + (address &amp; 0x7FFFFFFF));
+   if (IS_LOCAL_ADDRESS(address)) {
+//      std::cout &lt;&lt; &quot;local address sem bit ligado: &quot; &lt;&lt; ((unsigned int)address &amp; UNSET_BIT_LOCAL) &lt;&lt; std::endl;
+      return CBinString::getInt(_BS + realAddress(address));
    } else {
       std::cout &lt;&lt; &quot;ERRO !!! Invocando getInt com global address: &quot; &lt;&lt; address &lt;&lt; std::endl;
       return -1;

Modified: trunk/gpt2/gptvm/src/CRunBytecode.cpp
===================================================================
--- trunk/gpt2/gptvm/src/CRunBytecode.cpp	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/gptvm/src/CRunBytecode.cpp	2007-11-29 11:53:00 UTC (rev 400)
@@ -39,17 +39,14 @@
    }
 
    _opcodePointer[OP_NOP        ] = &amp;CRunBytecode::nopOpcode;
-   _opcodePointer[OP_PUSH_SREG  ] = &amp;CRunBytecode::pushSregOpcode;
-   _opcodePointer[OP_POP_SREG   ] = &amp;CRunBytecode::popSregOpcode;
-//   _opcodePointer[OP_PUSH       ] = &amp;CRunBytecode::pushOpcode;
-   _opcodePointer[OP_PUSH_STRING] = &amp;CRunBytecode::pushStringOpcode;
-//   _opcodePointer[OP_PUSH_1     ] = &amp;CRunBytecode::push1Opcode;
+//   _opcodePointer[OP_PUSHSREG   ] = &amp;CRunBytecode::pushsregOpcode;
+//   _opcodePointer[OP_POPSREG    ] = &amp;CRunBytecode::popsregOpcode;
    _opcodePointer[OP_PCALL      ] = &amp;CRunBytecode::pcallOpcode;
    _opcodePointer[OP_LIBCALL    ] = &amp;CRunBytecode::libcallOpcode;
-//   _opcodePointer[OP_EXIT_0     ] = &amp;CRunBytecode::exit0Opcode;
    _opcodePointer[OP_EXIT       ] = &amp;CRunBytecode::exitOpcode;
+   _opcodePointer[OP_EXIT0      ] = &amp;CRunBytecode::exit0Opcode;
+   _opcodePointer[OP_EXIT1      ] = &amp;CRunBytecode::exit1Opcode;
 
-//   OP_EXIT_1,
    _opcodePointer[OP_HLT        ] = &amp;CRunBytecode::hltOpcode;
 
    _opcodePointer[OP_ISUM       ] = &amp;CRunBytecode::isumOpcode;
@@ -124,34 +121,35 @@
    _opcodePointer[OP_JMP        ] = &amp;CRunBytecode::jmpOpcode;
    _opcodePointer[OP_IF         ] = &amp;CRunBytecode::ifOpcode;
    _opcodePointer[OP_IFNOT      ] = &amp;CRunBytecode::ifnotOpcode;
-   _opcodePointer[OP_POP        ] = &amp;CRunBytecode::popOpcode;
+   _opcodePointer[OP_POPSV      ] = &amp;CRunBytecode::popsvOpcode;
+   _opcodePointer[OP_POPIV      ] = &amp;CRunBytecode::popivOpcode;
+   _opcodePointer[OP_POPRV      ] = &amp;CRunBytecode::poprvOpcode;
+   _opcodePointer[OP_POPMV      ] = &amp;CRunBytecode::popmvOpcode;
    _opcodePointer[OP_INCSP      ] = &amp;CRunBytecode::incspOpcode;
    _opcodePointer[OP_DECSP      ] = &amp;CRunBytecode::decspOpcode;
+   _opcodePointer[OP_PUSH0      ] = &amp;CRunBytecode::push0Opcode;
+   _opcodePointer[OP_PUSH1      ] = &amp;CRunBytecode::push1Opcode;
+   _opcodePointer[OP_PUSH2      ] = &amp;CRunBytecode::push2Opcode;
+   _opcodePointer[OP_PUSH3      ] = &amp;CRunBytecode::push3Opcode;
+   _opcodePointer[OP_PUSH4      ] = &amp;CRunBytecode::push4Opcode;
+   _opcodePointer[OP_PUSH5      ] = &amp;CRunBytecode::push5Opcode;
+   _opcodePointer[OP_PUSHSV     ] = &amp;CRunBytecode::pushsvOpcode;
+   _opcodePointer[OP_PUSHIV     ] = &amp;CRunBytecode::pushivOpcode;
+   _opcodePointer[OP_PUSHRV     ] = &amp;CRunBytecode::pushrvOpcode;
+   _opcodePointer[OP_PUSHMV     ] = &amp;CRunBytecode::pushmvOpcode;
 
-//   OP_PUSH_0,
-//   OP_PUSH_2,
-//   OP_PUSH_3,
-//   OP_PUSH_4,
-//   OP_PUSH_5,
+   _opcodePointer[OP_PUSHST     ] = &amp;CRunBytecode::pushstOpcode;
+   _opcodePointer[OP_PUSHIT     ] = &amp;CRunBytecode::pushitOpcode;
+   _opcodePointer[OP_PUSHRT     ] = &amp;CRunBytecode::pushrtOpcode;
+   _opcodePointer[OP_PUSHCT     ] = &amp;CRunBytecode::pushctOpcode;
+   _opcodePointer[OP_PUSHBT     ] = &amp;CRunBytecode::pushbtOpcode;
+   _opcodePointer[OP_PUSHMT     ] = &amp;CRunBytecode::pushmtOpcode;
 
-   _opcodePointer[OP_PUSH_INT   ] = &amp;CRunBytecode::pushIntOpcode;
-   _opcodePointer[OP_PUSH_REAL  ] = &amp;CRunBytecode::pushRealOpcode;
-   _opcodePointer[OP_PUSH_CHAR  ] = &amp;CRunBytecode::pushCharOpcode;
-   _opcodePointer[OP_PUSH_BOOL  ] = &amp;CRunBytecode::pushBoolOpcode;
-   _opcodePointer[OP_PUSH_MATRIX] = &amp;CRunBytecode::pushMatrixOpcode;
+   _opcodePointer[OP_INCSP4     ] = &amp;CRunBytecode::incsp4Opcode;
+   _opcodePointer[OP_INCSP8     ] = &amp;CRunBytecode::incsp8Opcode;
+   _opcodePointer[OP_DECSP4     ] = &amp;CRunBytecode::decsp4Opcode;
+   _opcodePointer[OP_DECSP8     ] = &amp;CRunBytecode::decsp8Opcode;
 
-   _opcodePointer[OP_PUSH_STYPE ] = &amp;CRunBytecode::pushSTypeOpcode;
-   _opcodePointer[OP_PUSH_ITYPE ] = &amp;CRunBytecode::pushITypeOpcode;
-   _opcodePointer[OP_PUSH_RTYPE ] = &amp;CRunBytecode::pushRTypeOpcode;
-   _opcodePointer[OP_PUSH_CTYPE ] = &amp;CRunBytecode::pushCTypeOpcode;
-   _opcodePointer[OP_PUSH_BTYPE ] = &amp;CRunBytecode::pushBTypeOpcode;
-   _opcodePointer[OP_PUSH_MTYPE ] = &amp;CRunBytecode::pushMTypeOpcode;
-
-   _opcodePointer[OP_INCSP_4    ] = &amp;CRunBytecode::incsp4Opcode;
-//   OP_INCSP_8,
-   _opcodePointer[OP_DECSP_4    ] = &amp;CRunBytecode::decsp4Opcode;
-//   OP_DECSP_8,
-
    _opcodePointer[OP_RET        ] = &amp;CRunBytecode::retOpcode;
    _opcodePointer[OP_SALLOC     ] = &amp;CRunBytecode::sallocOpcode;
    _opcodePointer[OP_SFREE      ] = &amp;CRunBytecode::sfreeOpcode;
@@ -225,7 +223,8 @@
             std::cout &lt;&lt; _dataStack.popInt();
             break;
          case CSymbol::CHAR:
-            std::cout &lt;&lt; (char)_dataStack.popInt();
+//            std::cout &lt;&lt; (char)_dataStack.popInt();
+            std::cout &lt;&lt; &quot;char [&quot; &lt;&lt; (int)_dataStack.popInt() &lt;&lt; &quot;]&quot;;
             break;
          case CSymbol::BOOL:
             boolValue = _dataStack.popInt();
@@ -245,6 +244,39 @@
    std::cout &lt;&lt; std::endl;
 }
 
+
+void CRunBytecode::procLeia()
+{
+   int type = _dataStack.popInt();
+   int iValue = 0;
+   switch (type) {
+//      case CSymbol::STRING:
+//         _dataStack.pushString(std::cin);
+//         break;
+      case CSymbol::INT:
+         std::cin &gt;&gt; iValue;
+         _dataStack.pushInt(iValue);
+         break;
+//      case CSymbol::CHAR:
+//         std::cout &lt;&lt; (char)_dataStack.popInt();
+//         break;
+//      case CSymbol::BOOL:
+//         boolValue = _dataStack.popInt();
+//         if (boolValue == 0) {
+//            std::cout &lt;&lt; &quot;false&quot;;
+//         } else {
+//            std::cout &lt;&lt; &quot;true&quot;;
+//         }
+//         break;
+      case CSymbol::REAL:
+      case CSymbol::MATRIX:
+      default:
+         std::cout &lt;&lt; &quot;Tipo ainda nao suportado !!!&quot; &lt;&lt; std::endl;
+         abort();
+   }
+   std::cout &lt;&lt; std::endl;
+}
+
 /////////////
 // opcodes //
 /////////////
@@ -261,49 +293,40 @@
    // nothing to do
 }
 
-void CRunBytecode::pushSregOpcode()
-{
-   trace (&quot;push_sreg opcode&quot;);
+//void CRunBytecode::pushsregOpcode()
+//{
+//   invalidOpcode(__FUNCTION__);
+//   trace (&quot;pushsreg opcode&quot;);
+//
+//   _executionStack.push(_dataStack.getBS());
+//   _executionStack.push(_dataStack.getSP());
+//}
 
-   _executionStack.push(_dataStack.getBS());
-   _executionStack.push(_dataStack.getSP());
-}
+//void CRunBytecode::popsregOpcode()
+//{
+//   invalidOpcode(__FUNCTION__);
+//   trace (&quot;popsreg opcode&quot;);
+//
+//   _dataStack.setSP(_executionStack.top());
+//   _executionStack.pop();
+//
+//   _dataStack.setBS(_executionStack.top());
+//   _executionStack.pop();
+//
+//   // Ajusta o tamanho correto de _dataStack
+//   _dataStack.resize(_dataStack.getSP());
+//}
 
-void CRunBytecode::popSregOpcode()
-{
-   trace (&quot;pop_sreg opcode&quot;);
 
-   _dataStack.setSP(_executionStack.top());
-   _executionStack.pop();
-
-   _dataStack.setBS(_executionStack.top());
-   _executionStack.pop();
-}
-
-
-void CRunBytecode::pushStringOpcode()
-{
-   trace (&quot;push_string opcode&quot;);
-
-   int address = _code.fetchInt();
-
-   _dataStack.pushInt(address);
-}
-
-void CRunBytecode::pushSTypeOpcode()
-{
-   trace (&quot;push_stype opcode&quot;);
-
-   _dataStack.pushInt(CSymbol::STRING);
-}
-
-
 void CRunBytecode::pcallOpcode()
 {
    trace (&quot;pcall opcode&quot;);
 
-   _dataStack.setBS(_executionStack.top()); // TODO: verificar melhor isso...
+   _executionStack.push(_dataStack.getBS());
+//   _executionStack.push(_dataStack.getSP());
 
+   _dataStack.setBS(_dataStack.getSP());
+
    int address = _code.fetchInt();
 
    _executionStack.push(_code.getIP());
@@ -319,6 +342,8 @@
 
    if (_globalData.getCString(address) == &quot;imprima&quot;) {
       procImprima();
+   } else if (_globalData.getCString(address) == &quot;leia&quot;) {
+      procLeia();
    } else {
       error(&quot;libcall invocando subrotina desconhecida !!!&quot;);
    }
@@ -335,6 +360,26 @@
 }
 
 
+void CRunBytecode::exit0Opcode()
+{
+   trace (&quot;exit0 opcode&quot;);
+
+   _returnCode = 0;
+
+   _stop = true;
+}
+
+
+void CRunBytecode::exit1Opcode()
+{
+   trace (&quot;exit1 opcode&quot;);
+
+   _returnCode = 1;
+
+   _stop = true;
+}
+
+
 void CRunBytecode::hltOpcode()
 {
    trace (&quot;hlt opcode&quot;);
@@ -738,7 +783,7 @@
 
 void CRunBytecode::setIntData(const int &amp;address, const int &amp;value)
 {
-   if (address &amp; 0x80000000) {
+   if (IS_LOCAL_ADDRESS(address)) {
       _dataStack.setInt(address, value);
    } else {
 //      std::cout &lt;&lt; &quot;setIntData global address: &quot; &lt;&lt; address &lt;&lt; std::endl;
@@ -749,7 +794,7 @@
 
 int CRunBytecode::getIntData(const int &amp;address)
 {
-   if (address &amp; 0x80000000) {
+   if (IS_LOCAL_ADDRESS(address)) {
       return _dataStack.getInt(address);
    } else {
 //      std::cout &lt;&lt; &quot;global address: &quot; &lt;&lt; address &lt;&lt; std::endl;
@@ -760,7 +805,7 @@
 
 void CRunBytecode::setStringData(const int &amp;address, const std::string &amp;value)
 {
-   if (address &amp; 0x80000000) {
+   if (IS_LOCAL_ADDRESS(address)) {
       _dataStack.setCString(address, value);
    } else {
 //      std::cout &lt;&lt; &quot;setCStringData global address: &quot; &lt;&lt; address &lt;&lt; std::endl;
@@ -771,7 +816,7 @@
 
 std::string CRunBytecode::getStringData(const int &amp;address)
 {
-   if (address &amp; 0x80000000) {
+   if (IS_LOCAL_ADDRESS(address)) {
       return _dataStack.getCString(address);
    } else {
 //      std::cout &lt;&lt; &quot;global address: &quot; &lt;&lt; address &lt;&lt; std::endl;
@@ -858,11 +903,30 @@
    }
 }
 
-void CRunBytecode::popOpcode()
+void CRunBytecode::popsvOpcode()
 {
    invalidOpcode(__FUNCTION__);
 }
 
+void CRunBytecode::popivOpcode()
+{
+   trace (&quot;popiv opcode&quot;);
+
+   int address = _code.fetchInt();
+
+   setIntData(address, _dataStack.popInt());
+}
+
+void CRunBytecode::poprvOpcode()
+{
+   invalidOpcode(__FUNCTION__);
+}
+
+void CRunBytecode::popmvOpcode()
+{
+   invalidOpcode(__FUNCTION__);
+}
+
 void CRunBytecode::incspOpcode()
 {
    trace (&quot;incsp opcode&quot;);
@@ -883,76 +947,121 @@
 }
 
 
-//   OP_PUSH_0,
-//   OP_PUSH_2,
-//   OP_PUSH_3,
-//   OP_PUSH_4,
-//   OP_PUSH_5,
+void CRunBytecode::push0Opcode()
+{
+   trace (&quot;push0 opcode&quot;);
 
-void CRunBytecode::pushIntOpcode()
+   _dataStack.pushInt(0);
+}
+
+
+void CRunBytecode::push1Opcode()
 {
-   trace (&quot;push_int opcode&quot;);
+   trace (&quot;push1 opcode&quot;);
 
-   int address = _code.fetchInt();
+   _dataStack.pushInt(1);
+}
 
-   _dataStack.pushInt(getIntData(address));
+
+void CRunBytecode::push2Opcode()
+{
+   trace (&quot;push2 opcode&quot;);
+
+   _dataStack.pushInt(2);
 }
 
-void CRunBytecode::pushRealOpcode()
+
+void CRunBytecode::push3Opcode()
 {
-   trace (&quot;push_real opcode&quot;);
+   trace (&quot;push3 opcode&quot;);
 
-   invalidOpcode(__FUNCTION__);
+   _dataStack.pushInt(3);
 }
 
-void CRunBytecode::pushCharOpcode()
+
+void CRunBytecode::push4Opcode()
 {
-   trace (&quot;push_char opcode&quot;);
+   trace (&quot;push4 opcode&quot;);
 
-   invalidOpcode(__FUNCTION__);
+   _dataStack.pushInt(4);
 }
 
-void CRunBytecode::pushBoolOpcode()
+
+void CRunBytecode::push5Opcode()
 {
-   trace (&quot;push_bool opcode&quot;);
+   trace (&quot;push5 opcode&quot;);
 
+   _dataStack.pushInt(5);
+}
+
+
+void CRunBytecode::pushsvOpcode()
+{
+   trace (&quot;pushsv opcode&quot;);
+
+   int address = _code.fetchInt();
+
+   _dataStack.pushInt(address);
+}
+
+
+void CRunBytecode::pushivOpcode()
+{
+   trace (&quot;pushiv opcode&quot;);
+
+   int address = _code.fetchInt();
+
+   _dataStack.pushInt(getIntData(address));
+}
+
+void CRunBytecode::pushrvOpcode()
+{
+   trace (&quot;pushrv opcode&quot;);
+
    invalidOpcode(__FUNCTION__);
 }
 
-void CRunBytecode::pushMatrixOpcode()
+void CRunBytecode::pushmvOpcode()
 {
    invalidOpcode(__FUNCTION__);
 }
 
-void CRunBytecode::pushITypeOpcode()
+void CRunBytecode::pushstOpcode()
 {
-   trace (&quot;push_itype opcode&quot;);
+   trace (&quot;pushst opcode&quot;);
 
+   _dataStack.pushInt(CSymbol::STRING);
+}
+
+void CRunBytecode::pushitOpcode()
+{
+   trace (&quot;pushit opcode&quot;);
+
    _dataStack.pushInt(CSymbol::INT);
 }
 
-void CRunBytecode::pushRTypeOpcode()
+void CRunBytecode::pushrtOpcode()
 {
-   trace (&quot;push_rtype opcode&quot;);
+   trace (&quot;pushrt opcode&quot;);
 
    _dataStack.pushInt(CSymbol::REAL);
 }
 
-void CRunBytecode::pushCTypeOpcode()
+void CRunBytecode::pushctOpcode()
 {
-   trace (&quot;push_ctype opcode&quot;);
+   trace (&quot;pushct opcode&quot;);
 
    _dataStack.pushInt(CSymbol::CHAR);
 }
 
-void CRunBytecode::pushBTypeOpcode()
+void CRunBytecode::pushbtOpcode()
 {
-   trace (&quot;push_btype opcode&quot;);
+   trace (&quot;pushbt opcode&quot;);
 
    _dataStack.pushInt(CSymbol::BOOL);
 }
 
-void CRunBytecode::pushMTypeOpcode()
+void CRunBytecode::pushmtOpcode()
 {
    invalidOpcode(__FUNCTION__);
 }
@@ -960,28 +1069,49 @@
 
 void CRunBytecode::incsp4Opcode()
 {
-   trace (&quot;incsp_4 opcode&quot;);
+   trace (&quot;incsp4 opcode&quot;);
 
    _dataStack.pushInt(0);
 }
 
-//   OP_INCSP_8,
+void CRunBytecode::incsp8Opcode()
+{
+   trace (&quot;incsp8 opcode&quot;);
 
+   _dataStack.pushInt(0);
+   _dataStack.pushInt(0);
+}
+
 void CRunBytecode::decsp4Opcode()
 {
-   trace (&quot;decsp_4 opcode&quot;);
+   trace (&quot;decsp4 opcode&quot;);
 
    _dataStack.popInt();
 }
 
-//   OP_DECSP_8,
+void CRunBytecode::decsp8Opcode()
+{
+   trace (&quot;decsp8 opcode&quot;);
 
+   _dataStack.popInt();
+   _dataStack.popInt();
+}
+
 void CRunBytecode::retOpcode()
 {
    trace (&quot;ret opcode&quot;);
 
    _code.setIP(_executionStack.top());
    _executionStack.pop();
+
+//   _dataStack.setSP(_executionStack.top());
+//   _executionStack.pop();
+
+   _dataStack.setBS(_executionStack.top());
+   _executionStack.pop();
+
+//   // Ajusta o tamanho correto de _dataStack
+//   _dataStack.resize(_dataStack.getSP());
 }
 
 void CRunBytecode::sallocOpcode()

Modified: trunk/gpt2/gptvm/src/CRunBytecode.hpp
===================================================================
--- trunk/gpt2/gptvm/src/CRunBytecode.hpp	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/gptvm/src/CRunBytecode.hpp	2007-11-29 11:53:00 UTC (rev 400)
@@ -31,6 +31,7 @@
    void initOpcodePointer();
    void step();
    void procImprima();
+   void procLeia();
    void setIntData(const int &amp;address, const int &amp;value);
    int  getIntData(const int &amp;address);
    void setStringData(const int &amp;address, const std::string &amp;value);
@@ -38,17 +39,15 @@
    // opcodes
    void invalidOpcode(const std::string &amp;opcode=&quot;&quot;);
    void nopOpcode();
-   void pushSregOpcode();
-   void popSregOpcode();
-   void pushStringOpcode();
-   void pushSTypeOpcode();
+//   void pushsregOpcode();
+//   void popsregOpcode();
 //   void push1Opcode();
    void pcallOpcode();
    void libcallOpcode();
 //   void exit0Opcode();
    void exitOpcode();
-
-//   OP_EXIT_1,
+   void exit0Opcode();
+   void exit1Opcode();
    void hltOpcode();
 
    void isumOpcode();
@@ -123,32 +122,34 @@
    void jmpOpcode();
    void ifOpcode();
    void ifnotOpcode();
-   void popOpcode();
+   void popsvOpcode();
+   void popivOpcode();
+   void poprvOpcode();
+   void popmvOpcode();
    void incspOpcode();
    void decspOpcode();
+   void push0Opcode();
+   void push1Opcode();
+   void push2Opcode();
+   void push3Opcode();
+   void push4Opcode();
+   void push5Opcode();
+   void pushsvOpcode();
+   void pushivOpcode();
+   void pushrvOpcode();
+   void pushmvOpcode();
 
-//   OP_PUSH_0,
-//   OP_PUSH_2,
-//   OP_PUSH_3,
-//   OP_PUSH_4,
-//   OP_PUSH_5,
+   void pushstOpcode();
+   void pushitOpcode();
+   void pushrtOpcode();
+   void pushctOpcode();
+   void pushbtOpcode();
+   void pushmtOpcode();
 
-   void pushIntOpcode();
-   void pushRealOpcode();
-   void pushCharOpcode();
-   void pushBoolOpcode();
-   void pushMatrixOpcode();
-
-   void pushITypeOpcode();
-   void pushRTypeOpcode();
-   void pushCTypeOpcode();
-   void pushBTypeOpcode();
-   void pushMTypeOpcode();
-
    void incsp4Opcode();
-//   OP_INCSP_8,
+   void incsp8Opcode();
    void decsp4Opcode();
-//   OP_DECSP_8,
+   void decsp8Opcode();
 
    void retOpcode();
    void sallocOpcode();
@@ -171,7 +172,7 @@
    CSymbolTable  _symbolTable;
    CBinString    _globalData;
    CBytecode     _code;
-   OpcodePointer _opcodePointer[ OPCODE_NUMBER ];
+   OpcodePointer _opcodePointer[OPCODE_NUMBER];
    bool          _stop;
    int           _returnCode;
    CDataStack    _dataStack;

Modified: trunk/gpt2/gptvm/src/Makefile
===================================================================
--- trunk/gpt2/gptvm/src/Makefile	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/gptvm/src/Makefile	2007-11-29 11:53:00 UTC (rev 400)
@@ -8,7 +8,7 @@
 
 objects = main.o CGptVm.o CRunBytecode.o CBytecode.o CDataStack.o \
           $(COMMON_DIR)CSymbol.o $(COMMON_DIR)CSymbolTable.o \
-          $(COMMON_DIR)CHeader.o \
+          $(COMMON_DIR)CHeader.o $(COMMON_DIR)Tools.o\
           $(COMMON_DIR)CBinString.o $(COMMON_DIR)CSymbolList.o 
           
 all: $(objects)

Modified: trunk/gpt2/gptvm/test/gerados_pelo_gptasm/estruturas_condicionais_1.gvm
===================================================================
(Binary files differ)

Modified: trunk/gpt2/gptvm/test/gerados_pelo_gptasm/estruturas_repeticao_1.gvm
===================================================================
(Binary files differ)

Modified: trunk/gpt2/gptvm/test/gerados_pelo_gptasm/expressoes_matematicas_1.gvm
===================================================================
(Binary files differ)

Modified: trunk/gpt2/gptvm/test/gerados_pelo_gptasm/funcoes_definidas_usuario_1.gvm
===================================================================
(Binary files differ)

Modified: trunk/gpt2/gptvm/test/gerados_pelo_gptasm/invocando_subrotinas_linguagem_1.gvm
===================================================================
(Binary files differ)

Modified: trunk/gpt2/gptvm/test/gerados_pelo_gptasm/invocando_subrotinas_linguagem_2.gvm
===================================================================
(Binary files differ)

Modified: trunk/gpt2/gptvm/test/gerados_pelo_gptasm/procedimentos_definidos_usuario_1.gvm
===================================================================
(Binary files differ)

Modified: trunk/gpt2/gptvm/test/gerados_pelo_gptasm/procedimentos_definidos_usuario_2.gvm
===================================================================
(Binary files differ)

Modified: trunk/gpt2/gptvm/test/gerados_pelo_gptasm/procedimentos_definidos_usuario_3.gvm
===================================================================
(Binary files differ)

Modified: trunk/gpt2/gptvm/test/gerados_pelo_gptasm/variaveis_1.gvm
===================================================================
(Binary files differ)

Modified: trunk/gpt2/gptvm/test/gerados_pelo_gptasm/variaveis_2.gvm
===================================================================
(Binary files differ)

Modified: trunk/gpt2/gptvm/test/gerados_pelo_gptasm/variaveis_3.gvm
===================================================================
(Binary files differ)

Modified: trunk/gpt2/gptvm/test/gerados_pelo_gptasm/variaveis_4.gvm
===================================================================
(Binary files differ)

Modified: trunk/gpt2/gptvm/test/gerados_pelo_gptasm/variaveis_5.gvm
===================================================================
(Binary files differ)

Modified: trunk/gpt2/gptvm/test/gerados_pelo_gptasm/variaveis_6.gvm
===================================================================
(Binary files differ)

Modified: trunk/gpt2/gptvm/test/run.sh
===================================================================
--- trunk/gpt2/gptvm/test/run.sh	2007-11-27 19:01:45 UTC (rev 399)
+++ trunk/gpt2/gptvm/test/run.sh	2007-11-29 11:53:00 UTC (rev 400)
@@ -1,6 +1,6 @@
 rm $1.stdout 1&gt;/dev/null 2&gt;&amp;1
 
-../../gptvm $1 &gt; $1.stdout
+../../src/gptvm $1 &gt; $1.stdout
 if [ $? -ne 0 ]
 then
 	echo &quot;Erro: nao foi possivel executar $1.gvm&quot;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000073.html">[gpt-commit] r399 - in trunk/gpt2: gptasm/src gptvm/src
</A></li>
	<LI>Next message: <A HREF="000075.html">[gpt-commit] r401 - in trunk/gpt2: common/src gptasm/src	gptasm/test/wikki gptvm/src gptvm/test/gerados_pelo_gptasm
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#74">[ date ]</a>
              <a href="thread.html#74">[ thread ]</a>
              <a href="subject.html#74">[ subject ]</a>
              <a href="author.html#74">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/gpt-commit">More information about the gpt-commit
mailing list</a><br>
</body></html>
